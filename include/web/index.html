<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Blower Door</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%232563eb'/%3E%3Cpath d='M16 45V19h15c9 0 14 5 14 12 0 4-2 8-6 10l9 4H35l-8-4h-3v4h-8zm8-11h6c4 0 6-2 6-5s-2-5-6-5h-6v10z' fill='white'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="topbar">
    <div class="topbar-conn">
        <span class="conn-dot" id="connDot"></span>
        <span class="conn-label" id="connLabel">Connecting</span>
    </div>
    <span class="topbar-status" id="statusMsg">Idle</span>
    <button type="button" id="settingsBtn" class="btn-icon" aria-label="Settings">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
            <circle cx="10" cy="10" r="3"/><path d="M10 1.5v2m0 13v2M1.5 10h2m13 0h2M4.2 4.2l1.4 1.4m8.8 8.8 1.4 1.4m0-11.6-1.4 1.4M5.6 14.4l-1.4 1.4"/>
        </svg>
    </button>
</header>

<main class="container">

    <section class="cal-banner" id="calBanner">
        <div class="cal-content">
            <svg class="cal-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm-.75 4.75a.75.75 0 011.5 0v4a.75.75 0 01-1.5 0v-4zM10 14a1 1 0 110-2 1 1 0 010 2z"/>
            </svg>
            <div>
                <p class="cal-title" id="calTitle">Zero calibration required</p>
                <p class="cal-detail" id="calDetail">Calibrate sensors before starting any test</p>
            </div>
        </div>
        <button type="button" id="calibrateBtn" class="btn btn-cal">Calibrate</button>
    </section>

    <section class="hero">
        <article class="hero-card hero-card--ach">
            <span class="hero-label">Air Changes / Hour</span>
            <p class="hero-big" id="heroAch">--</p>
            <p class="hero-sub"><span id="heroModeLabel">n50</span> &middot; 5s avg &middot; instant <strong id="heroAchInstant">--</strong></p>
        </article>
        <article class="hero-card hero-card--pa">
            <span class="hero-label">Building Pressure</span>
            <p class="hero-med" id="heroPa">-- Pa</p>
            <p class="hero-sub">Target <strong id="heroTarget">50 Pa</strong></p>
        </article>
    </section>

    <section class="card mode-card" id="modeCard">
        <div class="mode-tabs">
            <button type="button" class="mode-tab active" data-mode="manual">Manual</button>
            <button type="button" class="mode-tab" data-mode="semi">Semi-Auto</button>
            <button type="button" class="mode-tab" data-mode="auto">Auto</button>
        </div>

        <div class="mode-panel" id="panelManual">
            <div class="manual-row">
                <span>Fan Power</span>
                <strong><span id="pwmDisplay">0</span>%</strong>
            </div>
            <input type="range" id="fanSlider" min="0" max="100" value="0">
            <div class="quick-grid">
                <button type="button" class="btn btn-quick" data-speed="0">0%</button>
                <button type="button" class="btn btn-quick" data-speed="20">20%</button>
                <button type="button" class="btn btn-quick" data-speed="40">40%</button>
                <button type="button" class="btn btn-quick" data-speed="60">60%</button>
                <button type="button" class="btn btn-quick" data-speed="80">80%</button>
                <button type="button" class="btn btn-quick" data-speed="100">100%</button>
            </div>
            <button type="button" id="manualStopBtn" class="btn btn-ghost btn-block">Stop Fan</button>
        </div>

        <div class="mode-panel hidden" id="panelSemi">
            <p class="semi-hint">Hold at target pressure</p>
            <div class="pressure-grid">
                <button type="button" class="btn btn-pa" data-pa="20">20 Pa</button>
                <button type="button" class="btn btn-pa" data-pa="30">30 Pa</button>
                <button type="button" class="btn btn-pa" data-pa="40">40 Pa</button>
                <button type="button" class="btn btn-pa" data-pa="50">50 Pa</button>
                <button type="button" class="btn btn-pa" data-pa="60">60 Pa</button>
                <button type="button" class="btn btn-pa" data-pa="75">75 Pa</button>
            </div>
            <button type="button" id="semiStopBtn" class="btn btn-ghost btn-block" disabled>Stop Hold</button>
        </div>

        <div class="mode-panel hidden" id="panelAuto">
            <div class="seg-control">
                <button type="button" class="seg-btn active" id="autoN50Btn">n50 &middot; 50 Pa</button>
                <button type="button" class="seg-btn" id="autoN75Btn">n75 &middot; 75 Pa</button>
            </div>
            <div class="auto-actions">
                <button type="button" id="startTestBtn" class="btn btn-primary">Start Test</button>
                <button type="button" id="stopTestBtn" class="btn btn-ghost">Stop Test</button>
            </div>
        </div>
    </section>

    <section class="card">
        <h3 class="section-title">Sensors</h3>
        <div class="sensor-grid">
            <div class="sensor-tile">
                <span class="s-label">Fan &Delta;P</span>
                <span class="s-value" id="fanPaVal">-- Pa</span>
                <span class="s-sub" id="fanTempVal">-- &deg;C</span>
                <span class="s-pill" id="fanStatusPill">--</span>
            </div>
            <div class="sensor-tile">
                <span class="s-label">Building &Delta;P</span>
                <span class="s-value" id="bldgPaVal">-- Pa</span>
                <span class="s-sub" id="bldgTempVal">-- &deg;C</span>
                <span class="s-pill" id="bldgStatusPill">--</span>
            </div>
            <div class="sensor-tile">
                <span class="s-label">Line Frequency</span>
                <span class="s-value" id="lineFreqVal">-- Hz</span>
            </div>
            <div class="sensor-tile">
                <span class="s-label">Applied Power</span>
                <span class="s-value" id="sensorPwmVal">-- %</span>
            </div>
        </div>
    </section>

</main>

<aside class="drawer" id="settingsDrawer" aria-hidden="true">
    <div class="drawer-head">
        <h2>Settings</h2>
        <button type="button" id="closeDrawerBtn" class="btn-icon" aria-label="Close">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M5 5l10 10M15 5L5 15"/></svg>
        </button>
    </div>
    <div class="drawer-body">
        <label class="field">
            <span>Indoor volume</span>
            <div class="input-row"><input type="number" id="buildingVolume" value="71" min="1" step="1"><span class="unit">m&sup3;</span></div>
        </label>
        <label class="field">
            <span>Fan opening diameter</span>
            <div class="input-row"><input type="number" id="fanApertureCm" value="31" min="5" max="60" step="0.1"><span class="unit">cm</span></div>
        </label>
        <label class="field">
            <span>Altitude above sea level</span>
            <div class="input-row"><input type="number" id="altitude" value="650" min="0" step="1"><span class="unit">m</span></div>
        </label>
        <p class="note">Effective area: <strong id="apertureAreaLabel">-- m&sup2;</strong></p>

        <details class="adv-block">
            <summary>Advanced</summary>
            <div class="adv-grid">
                <label class="field"><span>Coefficient C</span><input type="number" id="fanCoefC" value="236" min="0.1" step="0.1"></label>
                <label class="field"><span>Exponent n</span><input type="number" id="fanCoefN" value="0.60" min="0.1" step="0.01"></label>
                <label class="field">
                    <span>Anemometer speed</span>
                    <div class="input-row"><input type="number" id="anemoSpeed" min="0" step="0.01" placeholder="m/s"><span class="unit">m/s</span></div>
                </label>
            </div>
            <button type="button" id="applyAnemoBtn" class="btn btn-ghost btn-sm">Recalibrate C with anemometer</button>
        </details>

        <section class="ota-section">
            <h3>Firmware Update</h3>
            <p class="note">Active: <strong id="fwVersionLabel">--</strong></p>
            <label class="field"><span>Version label</span><input type="text" id="otaVersionInput" maxlength="23" placeholder="auto: active version"></label>
            <label class="field"><span>Firmware file (.bin)</span><input type="file" id="otaFileInput" accept=".bin,application/octet-stream"></label>
            <div class="ota-btns">
                <button type="button" id="otaUploadBtn" class="btn btn-primary btn-sm">Upload</button>
                <button type="button" id="otaApplyBtn" class="btn btn-ghost btn-sm">Apply &amp; Reboot</button>
            </div>
            <div class="ota-progress">
                <progress id="otaProgressBar" max="100" value="0"></progress>
                <small id="otaProgressLabel">OTA idle</small>
            </div>
        </section>
    </div>
</aside>

<div class="backdrop" id="drawerBackdrop" hidden></div>

<footer class="app-footer">
    <div class="footer-left">
        <span id="lastUpdate">Last update: --</span>
        <span id="fwVersion">Firmware: --</span>
    </div>
    <span class="footer-copy">&copy; pedromartinezweb.com</span>
</footer>

<script src="app.js"></script>
</body>
</html>
